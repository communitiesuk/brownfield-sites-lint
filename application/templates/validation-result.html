{% extends "dlf-base.html" %}
{% from "macros/validation-result-panel.html" import validationResultPanel2 %}

{% block beforeContent %}
  {{ super() }}
  <a href="{{ url_for('frontend.validate') }}" class="govuk-back-link">Back</a>
{% endblock %}

{% block content %}

<!-- show overall result -->
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
  {% if result.valid() %}
  {{ validationResultPanel2(true) }}
  {% else %}
  {{ validationResultPanel2(false, result.error_count()) }}
  {% endif %}
  </div>
</div>

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <h1 class="govuk-heading-xl govuk-!-margin-top-6">Validation overview</h1>

      <table class="govuk-table">
        <tbody class="govuk-table__body">

          <!-- what type of file was uploaded -->
          <tr class="govuk-table__row">
            <th class="govuk-table__header" scope="row">File type</th>
            <td class="govuk-table__cell govuk-table__cell--numeric">{{ result.file_type() }}</td>
          </tr>

          <!-- were we able to extract name of Local Authority -->
          <tr class="govuk-table__row">
            <th class="govuk-table__header" scope="row">Local Authority</th>
            <td class="govuk-table__cell govuk-table__cell--numeric">{{ result.planning_authority() }}</td>
          </tr>

          <!-- check column headers (row 1) against expected columns -->
          <tr class="govuk-table__row">
            <th class="govuk-table__header" scope="row">Column headers</th>
            <td class="govuk-table__cell govuk-table__cell--numeric"><a href="#column-issues-section">{{ result.check_headers() }}</a></td>
          </tr>

          <!-- is the data valid -->
          <tr class="govuk-table__row">
            <th class="govuk-table__header" scope="row">Total rows found</th>
            <td class="govuk-table__cell govuk-table__cell--numeric">{{ result.row_count() }}</td>
          </tr>
          <tr class="govuk-table__row">
            <th class="govuk-table__header" scope="row">Invalid rows</th>
            <td class="govuk-table__cell govuk-table__cell--numeric"><a href="#data-issues-section">{{ result.row_count() - result.valid_row_count() }}</a></td>
          </tr>

        </tbody>
      </table>

    </div>
</div>

{% if not result.valid() %}
<!-- section to highlight issues with the file -->
<!--
<div id="file-issues-section" class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h2 class="govuk-heading-l govuk-!-margin-top-9">File content</h2>
    <p class="govuk-body">The file contains things that are not part of the standard. These are:</p>
    <ul class="govuk-list govuk-list--bullet">
      <li>empty rows</li>
      <li>additional content</li>
    </ul>
  </div>
</div>-->
{%- endif -%}

{%- if result.additional_headers()|length > 0 or result.missing_headers()|length > 0 -%}
<!-- section for listing issues with columns -->
<div id="column-issues-section" class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h2 class="govuk-heading-l govuk-!-margin-top-9">Column headers</h2>
    <p class="govuk-body">Column headers in your register contain errors. They need to match the names stated in the <a href="https://www.gov.uk/government/publications/brownfield-land-registers-data-standard/publish-your-brownfield-land-data">brownfield land guidance</a> exactly.</p>
    <div class="govuk-inset-text">
        Column headings are case sensitive. Avoid common issues by checking spelling and letter case specified in the guidance.
    </div>
  </div>
</div>


<h3 class="govuk-heading-m">Data standard headers</h3>
<p class="govuk-body">Below are the headers that are part of the brownfield land registers data standard.</p>
<ul class="govuk-list field-list {{ ' field-list--columns' if brownfield_standard.v2_standard_headers()|length > 4 else ' ' }}">
  {% for header in brownfield_standard.v2_standard_headers() %}
  <li class="field-list__item{% if not header in result.headers_found() %} error{% endif %}">
    {{ header }}
    <span class="govuk-tag{% if not header in result.headers_found() %} govuk-tag--error{% endif %}">{{ "Found" if header in result.headers_found() else "Missing" }}</span>
  </li>
  {% endfor %}
</ul>

<p class="govuk-body">Your register included the following headers that are no longer required. We haven't validated the values for these headers. You can remove them from your register if you wish.</p>

<ul class="govuk-list field-list{{ ' field-list--columns' if result.deprecated_headers_found()|length > 4 else ' ' }}">
  {% for header in result.deprecated_headers_found() %}
  <li class="field-list__item">
    {{ header }}
    <span class="govuk-tag govuk-tag--warning">Deprecated</span>
  </li>
  {% endfor %}
</ul>

<details class="govuk-details govuk-details--close">
  <summary class="govuk-details__summary">Why are some headers marked as deprecated?</summary>
  <div class="govuk-details__text">
    <p class="govuk-body">Some fields have been deprecated. You no longer need to include them. You can still include them if you want but we display them below to warn you that they are no longer needed.</p>
    <p class="govuk-body">You must not include any fields that are neither part of the standard or deprecated. Any additional fields will be shown here.</p>
  </div>
</details>

{% if result.extra_headers_found() %}
<h3 class="govuk-heading-m">Unknown</h3>
<p class="govuk-body">There were some headers in your CSV file that we do not recognise. These could be misspelt headers or headers that aren't required.</p>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-half">
    <ul class="govuk-list field-list">
      {% for header in result.extra_headers_found() %}
      <li class="field-list__item">{{ header }}</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

{% if result.missing_headers()|length > 0 %}
<div class="highlight-box--cta highlight-box--wide">
  <!--<h4 class="highlight-box__title govuk-heading-s">Fix your headers</h4>-->
  <p class="govuk-body">We recommend you fix any issues with your headers now. When there are missing or incorrect headers we can not attempt to validate all the values included in your register.</p>
  <p class="govuk-body"><a href="{{ url_for('frontend.edit_headers', result=result.id) }}" class="govuk-link">Edit your headers</a>.</p>
</div>
{% endif %}

{%- endif -%}

{% if not result.valid() %}
<!-- section to highlight issues with the file -->
<!--
<div id="file-issues-section" class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h2 class="govuk-heading-l govuk-!-margin-top-9">File content</h2>
    <p class="govuk-body">The file contains things that are not part of the standard. These are:</p>
    <ul class="govuk-list govuk-list--bullet">
      <li>empty rows</li>
      <li>additional content</li>
    </ul>
  </div>
</div>-->

<!-- section for listing issues with the data -->
<div id="data-issues-section" class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h2 class="govuk-heading-l govuk-!-margin-top-9">Register data</h2>
    <p class="govuk-body">Data errors occur when the values are not in the expected format as laid out in the <a href="https://www.gov.uk/government/publications/brownfield-land-registers-data-standard/publish-your-brownfield-land-data" class="govuk-link">brownfield land standard</a>.</p>

    {#- subtract number of missing headers times number of rows from overall error count displayed here -#}
    {% set number_of_errors = result.error_count() - result.missing_headers()|length %}
    <p class="govuk-body">Your register has <span class="inline-error-text govuk-!-font-size-24">{{ number_of_errors }} {{ "error"|pluralise("", "s", number_of_errors) }}</span>. The errors occurred under the headers listed.</p>

    <ul class="govuk-list">
      {% for column, error in result.errors_by_column.items() %}
          <li>
            <h3 class="govuk-heading-s">{{ column }}</h3>
            {% for msg in error.messages %}
              <p class="no-margin">
                  {{ msg|markdown}}
              </p>
            {% endfor %}
            <p>We found errors across <span class="row-value">{{ error.rows|count }} {{ "row"|pluralise("", "s", error.rows|count) }}</span>.
            </p>
            <details class="govuk-details">
              <summary class="govuk-details__summary">See all incorrect rows</summary>
              <div class="govuk-details__text">
                <ul class="govuk-list">
                  {% for e in error.errors %}<li><span class="govuk-tag govuk-tag--error">{% if e.row == 0 %}Header row{% else %}Row {{ e.row }}{% endif %}</span> {{ e.message }}</li>{% endfor %}
                </ul>
                {% if "Date" in column %}
                <div class="highlight-box--cta highlight-box--flush">
                  <p class="govuk-body">We can fix these dates and let you download an updated CSV file. <a href="{{ url_for('frontend.edit_column', result=result.id, column=column) }}" class="govuk-link">Correct these dates</a>.</p>
                </div>
                {% endif %}
              </div>
            </details>
          </li>
      {% endfor %}
    </ul>

  </div>
</div>
{% endif %}

{%- if register_updated_at -%}
<hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
<p class="govuk-body">Your register has been updated. <a href="{{ url_for('frontend.get_csv', result=result.id) }}" class="govuk-link">Download the latest version</a>.</p>
{%- endif -%}

{% if result.valid() %}
    <!-- should only be shown if able to plot brownfield sites -->
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        <!--<h2 class="govuk-heading-l govuk-!-margin-top-9">Brownfield site locations</h2>
        <p class="govuk-body">Using the data found we were able to plot these brownfield sites.</p>
        <div id="map-original" style="height: 1px;"></div>-->
        <h2 class="govuk-heading-l govuk-!-margin-top-6">What happens next</h2>
        <p class="govuk-body">
          Your register contains valid brownfield site data.
        </p>
        <p class="govuk-body">
          You should now publish the register on your LPA website. If you already have a published register you should either update it with the new data or replace the file with the file you checked.
        </p>

        <div class="govuk-inset-text">You should not remove brownfield sites from your register. Old sites should be marked as such using the "EndDate" field.</div>

        <!--<p class="govuk-body">
          <a href="#" class="govuk-link">What did you think of this service?</a> (takes 30 seconds)
        </p>-->
      </div>
    </div>
{% endif %}

{% if config.ENV == 'development' %}
    <h2 class="govuk-heading-l govuk-!-margin-top-9">Raw results</h2>
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <details>
                <summary class="govuk-body">Raw validation results</summary>
                <pre>{{ result.result|tojson(indent=2) }}</pre>
            </details>
        </div>
    </div>

    <h2 class="govuk-heading-l govuk-!-margin-top-9">Report as json</h2>
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <details>
                <summary class="govuk-body">Report as json</summary>
                <pre>{{ result.to_dict()|tojson(indent=2) }}</pre>
            </details>
        </div>
    </div>

{% endif %}


{% endblock %}